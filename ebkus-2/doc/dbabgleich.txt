Regeln für Datenabgleich mehrerer Stellen
-----------------------------------------

Prämissen: 
----------

1. Jede Datenbanksite kann mehrere Dienststellen haben.
   Datenbanksite und Dienststelle sind nicht identisch und im Programm
   getrennt, nach DBSITE und Stellenzeichen.
2. Jede Stelle sieht nur die Daten der eigenen Stelle. Ausnahme:
   Anonyme statisitisiche Daten sind allen Stellen zugänglich.
3. Jede Datenbank hat unterschiedliche, eigene ID-Räume.
6. Code und Mitarbeiter sind in allen DB-Sites identisch.
4. Jede Site ist Masterdb bei Akte/Statistik, die  ihr stzei hat.
5. Es gibt 1 Masterdb für Code u. Mitarbeiter, d.h.
   1 Masterdb exportiert Code u. Mitarbeiter, die anderen importieren
   diesen und exportieren keinen Code u. Mitarbeiter in die Masterdb.
6. Es werden Akten und Statistik von anderen DatenbankSites in die
   Masterdb exportiert, die Masterdb exportiert nur Code und die Mitarbeiterids.

------------------------------------

Umsetzung:
Ausgang:
1. Jede Änderung bei den Akten/Fall bezogenen Tabellen wird im Feld
   'zeit' mit time() gespeichert, jede bei den Statistiktabellen seperat
   in feld 'zeit' in fachstat und jghstat.
2. Ist Wert im Feld akte['zeit'] kleiner als das in abgleichsprot['zeit']
   und Stellenzeichen in
   Akte identisch mit DB-Site wird die Akte/Fall insgesamt exportiert.
   (analog Statistik).
3. Statistik: (2 Fälle: mit fall_id, ohne fall_id, evtl. getrennt
   behandeln), nach Änderung/neu exportieren.
4. Export/importzeitpunkt wird, wenn erfolgreich, in Tabelle abgleichsprot
   vermerkt.
   vier felder: 
   id, mit_id, stzei, zeit, inout, abgl(vollst./incr/Aktenwechsel)
5. Möglichkeit implementieren:
   alle Daten vollständig (Auswahl vgl. oben) mit Stellenzeichen
   zu exportieren (falls bei der anderen Site Fehler
   auftreten etc.), d.h. quasi incrementeller und vollständiger
   Export.
Eingang:
1. 2 Fälle: 
   existiert identische id: update, sonst:
   insert.
2. für eingang zugelassen: 
   bei Akten/Statistik: gleiche id, neü id, 
   stzei der anderen sites für Daten mit stzei 
   der anderen sites. Nie: stzei der eigenen site (ausser:
   Akten-/Fallabgabe, was hier nicht behandelt wird. extra Vorgang).
3. bei Code,Mitarbeiter: nur Masterdb (aus ebapih: DEFAULT_MASTERDB) 
4. Default: Export-DBsite gewinnt (stzei); Masterdb default bei Code
   und Mitarbeiter, d.h. es wird alles genommen, was das
   stzei der exportdb hat (Prüfung auf richtige id's ???) und Code
   Mitarbeiter nur, wenn importfile von masterdb kommt.
5. Bei vollständigem Import einer Site evtl. erst alle Daten der 
   fremden Site löschen, dann importieren (oder Nichtübereinstimmung
   nach vollständigem Abgleich protokollieren, 
   Löschmöglichkeit anbieten.).
5. Fehlerprotokoll: alle fehlerhaften Datensätze in extra-files 
   speichern (gegenenfalls: wiederholung von ein-/aus für diese)
   z.Bsp: gleiche Aktenid, jedoch verschiedenes stzeiaktüll)
6. Protokoll in abgleichstabelle.
-----------
Spezialfall (ausserhalb des DB-Abgleichs behandeln, eigener Vorgang):
- Aktenaustausch von Site B nach A zum Zweck der Bearbeitung auf A
  oder falls eine DB-Site schliesst und alles auf eine andere
  bestehende (zur Masterdb zugehörige site) importiert 
  werden muss.
- ändern des stzeiakt auf A an der Site B, ausgang Site B, eingang
  Site A.
- in dem Fall dürfen fremde stzei in die Site importiert werden.
  und ein update des stzei auf Site A beim Eingang von stzei 'B' nach 'A'
  erfolgen.
- stzei B auf der Site A darf in dem Fall (nur) beim Eingang von 
  B auf A updatet werden (voraussetzung: gleiche id).
-----------

generell: parallele Akteneinträge auf mehreren sites gibt es nicht, so dass
immer die site, welche die Akte führt, das update-Recht auf der
anderen Db-Site hat.
austauschregeln gelten nur für DB-Sites, welche zu 1 Masterdb
gehören, wg. codes, Mitarbeiter.
verhindern, dass abgleichsfiles der exp. Site dort 
reimportierbar sind (backups wären getrennt zu behandeln.)



